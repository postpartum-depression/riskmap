{% extends 'base.html' %}

{% block title %}{{ vulnerability.name }} - RiskMap{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>
            <i class="fas fa-bug"></i> {{ vulnerability.name }}
        </h2>
        <a href="{% url 'core:vulnerabilities' %}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> К списку
        </a>
    </div>
</div>

<!-- Основная информация -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Описание -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> Описание</h3>
            <span class="badge badge-{{ vulnerability.criticality }}" style="font-size: 1rem;">
                {{ vulnerability.get_criticality_display }} критичность
            </span>
        </div>
        <div class="card-body">
            <p style="font-size: 1.05rem; line-height: 1.8;">
                {{ vulnerability.description }}
            </p>
            
            {% if vulnerability.attack_type %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light-bg); border-radius: 8px;">
                <strong><i class="fas fa-shield-virus"></i> Тип атаки:</strong>
                <span style="margin-left: 0.5rem;">{{ vulnerability.attack_type }}</span>
            </div>
            {% endif %}
            
            {% if vulnerability.cwe_id %}
            <div style="margin-top: 1rem; padding: 1rem; background: var(--light-bg); border-radius: 8px;">
                <strong><i class="fas fa-tag"></i> CWE ID:</strong>
                <span style="margin-left: 0.5rem;">{{ vulnerability.cwe_id }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Боковая панель -->
    <div>
        <!-- Статистика -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-chart-bar"></i> Статистика</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem;">
                    <div style="color: var(--light-text); font-size: 0.9rem;">Уровень критичности</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: 
                        {% if vulnerability.criticality == 'high' %}var(--danger-color)
                        {% elif vulnerability.criticality == 'medium' %}var(--warning-color)
                        {% else %}var(--success-color){% endif %};">
                        {{ vulnerability.get_criticality_display }}
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="color: var(--light-text); font-size: 0.9rem;">Рекомендаций</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">
                        {{ recommendations.count }}
                    </div>
                </div>
                
                <div>
                    <div style="color: var(--light-text); font-size: 0.9rem;">Дата добавления</div>
                    <div style="font-size: 1rem;">
                        {{ vulnerability.created_at|date:"d.m.Y" }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Влияние на процесс пользователя -->
        {% if user_relation %}
        <div class="card" style="border-left: 4px solid var(--warning-color);">
            <div class="card-header">
                <h3><i class="fas fa-exclamation-triangle"></i> В вашем процессе</h3>
            </div>
            <div class="card-body">
                <p style="margin-bottom: 1rem;">
                    Эта уязвимость обнаружена в блоке:
                    <strong>{{ user_relation.process_block.name }}</strong>
                </p>
                <div style="margin-bottom: 0.5rem;">
                    <span style="color: var(--light-text);">Уровень влияния:</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="flex: 1; height: 10px; background: var(--light-bg); border-radius: 5px; overflow: hidden;">
                        <div style="width: {{ user_relation.impact_level }}0%; height: 100%; background: var(--danger-color);"></div>
                    </div>
                    <strong>{{ user_relation.impact_level }}/10</strong>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Рекомендации -->
{% if recommendations %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-lightbulb"></i> Рекомендации по устранению</h2>
    </div>
    <div class="card-body">
        {% for rec in recommendations %}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: 
            {% if rec.priority == 1 %}#fff3cd
            {% else %}var(--light-bg){% endif %}; 
            border-radius: 12px; border-left: 4px solid 
            {% if rec.priority == 1 %}var(--warning-color)
            {% else %}var(--secondary-color){% endif %};">
            
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <h3 style="color: var(--primary-color); font-size: 1.3rem;">
                    {{ forloop.counter }}. {{ rec.title }}
                </h3>
                <div style="display: flex; gap: 0.5rem;">
                    {% if rec.priority == 1 %}
                    <span class="badge badge-warning">Приоритет</span>
                    {% endif %}
                    <span class="badge" style="background: 
                        {% if rec.implementation_difficulty == 'easy' %}var(--success-color)
                        {% elif rec.implementation_difficulty == 'medium' %}var(--warning-color)
                        {% else %}var(--danger-color){% endif %}; color: white;">
                        {{ rec.get_implementation_difficulty_display }}
                    </span>
                </div>
            </div>
            
            <p style="line-height: 1.8; font-size: 1.05rem;">
                {{ rec.content }}
            </p>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 2rem;">
        <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--light-text); margin-bottom: 1rem;"></i>
        <p style="color: var(--light-text);">
            Рекомендации для этой уязвимости пока не добавлены
        </p>
    </div>
</div>
{% endif %}
{% endblock %}
