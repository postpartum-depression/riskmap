{% extends 'base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - RiskMap{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
        <h1 class="h2">–î–∞—à–±–æ—Ä–¥ —Ä–∏—Å–∫–æ–≤</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{% url 'core:process_list' %}" class="btn btn-sm btn-outline-primary">–ü—Ä–æ—Ü–µ—Å—Å—ã</a>
                <a href="{% url 'core:vulnerability_list' %}" class="btn btn-sm btn-outline-primary">–£—è–∑–≤–∏–º–æ—Å—Ç–∏</a>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (KPI) -->
    <div class="row mb-4">
        <!-- –í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">–í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.total }}</div>
                        </div>
                        <div class="col-auto">
                            <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Å–∏–º–≤–æ–ª—ã –µ—Å–ª–∏ –Ω–µ—Ç FontAwesome, –∏–ª–∏ –∏–∫–æ–Ω–∫–∏ Bootstrap -->
                            <div style="font-size: 2rem; color: #dddfeb;">üêû</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.high }}</div>
                        </div>
                        <div class="col-auto">
                            <div style="font-size: 2rem; color: #dddfeb;">‚ö†Ô∏è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.resolved }}</div>
                        </div>
                        <div class="col-auto">
                            <div style="font-size: 2rem; color: #dddfeb;">‚úÖ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ processes_count }}</div>
                        </div>
                        <div class="col-auto">
                            <div style="font-size: 2rem; color: #dddfeb;">üìä</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <div class="row">
        <!-- Bar Chart: –†–∏—Å–∫–∏ –ø–æ –ø—Ä–æ—Ü–µ—Å—Å–∞–º -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-primary">–¢–æ–ø —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area" style="position: relative; height: 300px;">
                        <canvas id="riskBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie Chart: –°—Ç–∞—Ç—É—Å—ã -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-primary">–°—Ç–∞—Ç—É—Å—ã —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="position: relative; height: 300px;">
                        <canvas id="statusPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤
    const colors = {
        primary: '#4e73df',
        success: '#1cc88a',
        info: '#36b9cc',
        warning: '#f6c23e',
        danger: '#e74a3b',
        secondary: '#858796',
        light: '#f8f9fc',
    };

    // --- –ì—Ä–∞—Ñ–∏–∫ 1: Bar Chart (–†–∏—Å–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤) ---
    const ctxBar = document.getElementById('riskBarChart').getContext('2d');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
    const riskLabels = {{ risk_chart_labels|safe }};
    const riskData = {{ risk_chart_data|safe }};

    if (riskLabels.length > 0) {
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: riskLabels,
                datasets: [{
                    label: '–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ (Score)',
                    data: riskData,
                    backgroundColor: colors.primary,
                    hoverBackgroundColor: '#2e59d9',
                    borderColor: '#4e73df',
                    borderRadius: 5, // –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤
                    maxBarThickness: 50,
                }],
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ - 100
                        grid: {
                            borderDash: [2],
                            drawBorder: false,
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                        },
                        title: {
                            display: true,
                            text: '–ë–∞–ª–ª—ã —Ä–∏—Å–∫–∞ (0-100)'
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    } else {
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–∏—à–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
        ctxBar.font = "16px Arial";
        ctxBar.fillStyle = "gray";
        ctxBar.textAlign = "center";
        ctxBar.fillText("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö", ctxBar.canvas.width/2, ctxBar.canvas.height/2);
    }

    // --- –ì—Ä–∞—Ñ–∏–∫ 2: Doughnut Chart (–°—Ç–∞—Ç—É—Å—ã) ---
    const ctxPie = document.getElementById('statusPieChart').getContext('2d');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const openCount = {{ status_chart_open }};
    const progressCount = {{ status_chart_in_progress }};
    const resolvedCount = {{ status_chart_resolved }};
    const closedCount = {{ status_chart_closed }};
    const totalStatus = openCount + progressCount + resolvedCount + closedCount;

    if (totalStatus > 0) {
        new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['–û—Ç–∫—Ä—ã—Ç–∞', '–í —Ä–∞–±–æ—Ç–µ', '–†–µ—à–µ–Ω–∞', '–ó–∞–∫—Ä—ã—Ç–∞'],
                datasets: [{
                    data: [openCount, progressCount, resolvedCount, closedCount],
                    backgroundColor: [colors.danger, colors.warning, colors.success, colors.secondary],
                    hoverBackgroundColor: ['#be2617', '#dda20a', '#17a673', '#60616f'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                    borderWidth: 2
                }],
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                cutout: '70%', // –†–∞–∑–º–µ—Ä –¥—ã—Ä–∫–∏ –±—É–±–ª–∏–∫–∞
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
    } else {
        ctxPie.font = "16px Arial";
        ctxPie.fillStyle = "gray";
        ctxPie.textAlign = "center";
        ctxPie.fillText("–ù–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π", ctxPie.canvas.width/2, ctxPie.canvas.height/2);
    }
</script>
{% endblock %}
